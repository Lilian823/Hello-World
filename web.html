<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能数据库问答系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: var(--light-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .chat-container {
            background: rgba(30, 30, 46, 0.8);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-top: 30px;
            max-width: 1200px;
            height: 75vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: rgba(67, 97, 238, 0.2);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: rgba(67, 97, 238, 0.3);
            border: 1px solid rgba(67, 97, 238, 0.5);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .system-message {
            background: rgba(30, 30, 46, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .sql-message {
            background: rgba(23, 42, 58, 0.8);
            border-left: 4px solid var(--success-color);
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        .input-container {
            padding: 15px;
            background: rgba(30, 30, 46, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-group {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .visualization-container {
            background: rgba(23, 42, 58, 0.6);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .table-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .table {
            color: white;
            background: rgba(30, 30, 46, 0.5);
        }
        
        .table th {
            background: rgba(67, 97, 238, 0.3);
        }
        
        .table-striped>tbody>tr:nth-of-type(odd) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .badge-sql {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 18px;
            background: rgba(30, 30, 46, 0.7);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 20px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected { background: #4ade80; }
        .disconnected { background: #f87171; }
        
        .examples {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .example-card {
            background: rgba(67, 97, 238, 0.2);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .example-card:hover {
            background: rgba(67, 97, 238, 0.3);
            transform: translateY(-3px);
        }
        
        .feature-icon {
            width: 60px;
            height: 60px;
            background: rgba(67, 97, 238, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .config-modal {
            color: #333;
        }
        
        .sql-copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(23, 42, 58, 0.8);
            color: #4cc9f0;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .chat-container {
                height: 65vh;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <header class="header sticky-top">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-database fa-2x me-3 text-primary"></i>
                    <h1 class="h3 mb-0">智能数据库问答系统</h1>
                </div>
                <div class="d-flex">
                    <button class="btn btn-sm btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#configModal">
                        <i class="fas fa-cog me-1"></i> 设置
                    </button>
                    <button class="btn btn-sm btn-primary" id="connectBtn">
                        <i class="fas fa-plug me-1"></i> 连接数据库
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- 状态栏 -->
                <div class="status-bar rounded mb-2">
                    <div class="connection-status">
                        <span class="status-dot" id="dbStatusDot"></span>
                        <span id="dbStatusText">正在连接数据库...</span>
                    </div>
                    <div>
                        <span class="badge bg-success" id="modelStatus">Text2SQL 模型: 初始化中...</span>
                    </div>
                </div>
                
                <!-- 聊天容器 -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h5 class="mb-0"><i class="fas fa-comments me-2"></i>数据库智能问答</h5>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- 系统欢迎消息 -->
                        <div class="message system-message">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-robot me-2 text-success"></i>
                                <strong>数据库助手</strong>
                            </div>
                            <p>您好！我是您的数据库智能助手，可以将自然语言问题转换为SQL查询。您可以询问类似以下问题：</p>
                            <ul>
                                <li>上季度销售额最高的产品是哪一款？</li>
                                <li>显示上海地区最近三个月的销售趋势</li>
                                <li>哪些客户的购买金额超过10万元？</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg bg-dark text-light border-dark" 
                                   placeholder="输入关于数据库的问题..." id="userInput"
                                   aria-label="输入关于数据库的问题">
                            <button class="btn btn-primary" type="button" id="sendBtn">
                                <i class="fas fa-paper-plane me-1"></i> 发送
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 结果可视化区域 -->
                <div class="visualization-container mt-3" id="visualizationContainer">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-chart-bar me-2"></i>查询结果可视化</h5>
                        <div class="btn-group" id="viewToggle">
                            <button class="btn btn-sm btn-outline-light active" data-type="chart">
                                <i class="fas fa-chart-line"></i> 图表
                            </button>
                            <button class="btn btn-sm btn-outline-light" data-type="table">
                                <i class="fas fa-table"></i> 表格
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="resultChart"></canvas>
                    </div>
                    
                    <div class="table-container d-none">
                        <table class="table table-striped" id="resultTable">
                            <thead>
                                <tr id="tableHeader"></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 示例问题 -->
                <div class="examples">
                    <h5 class="mb-3"><i class="fas fa-lightbulb me-2"></i>试试这些示例问题:</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="example-card" data-question="显示各个产品类别在2023年的总销售额">
                                <i class="fas fa-shopping-cart mb-2"></i>
                                <p class="mb-0">显示各个产品类别在2023年的总销售额</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="example-card" data-question="找出最近一个月订单量最多的前5位客户">
                                <i class="fas fa-users mb-2"></i>
                                <p class="mb-0">找出最近一个月订单量最多的前5位客户</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="example-card" data-question="比较上海和北京地区本季度的销售业绩">
                                <i class="fas fa-city mb-2"></i>
                                <p class="mb-0">比较上海和北京地区本季度的销售业绩</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能特性 -->
    <div class="container mt-5">
        <h3 class="text-center mb-4">系统核心功能</h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="text-center p-4">
                    <div class="feature-icon mx-auto">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <h5>自然语言理解</h5>
                    <p class="mb-0">理解各种形式的自然语言查询，包括口语化和复杂问题</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-4">
                    <div class="feature-icon mx-auto">
                        <i class="fas fa-database"></i>
                    </div>
                    <h5>Text2SQL转换</h5>
                    <p class="mb-0">将问题精准转换为SQL查询，支持复杂查询和关联操作</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-4">
                    <div class="feature-icon mx-auto">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5>智能可视化</h5>
                    <p class="mb-0">自动选择最佳图表展示查询结果，支持表格切换</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-4">
                    <div class="feature-icon mx-auto">
                        <i class="fas fa-history"></i>
                    </div>
                    <h5>上下文关联</h5>
                    <p class="mb-0">支持多轮对话，理解上下文信息，无需重复提问</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div class="modal fade config-modal" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel">系统设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">API 地址</label>
                            <input type="text" class="form-control" id="apiUrl" value="http://localhost:5000/api/query">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">数据库连接</label>
                            <input type="text" class="form-control" id="dbConnection" value="mysql://user:pass@localhost:3306/sales_db">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Text2SQL 模型</label>
                            <select class="form-select" id="modelSelect">
                                <option value="gpt-4">GPT-4</option>
                                <option value="claude-2">Claude 2</option>
                                <option value="llama-2">Llama 2</option>
                                <option value="codellama">CodeLlama</option>
                            </select>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="autoVisualize" checked>
                            <label class="form-check-label" for="autoVisualize">自动可视化结果</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveConfig">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 系统配置
        let config = {
            apiUrl: 'http://localhost:5000/api/query',
            dbConnection: 'mysql://user:pass@localhost:3306/sales_db',
            model: 'gpt-4',
            autoVisualize: true
        };
        
        // 对话状态
        let conversationId = null;
        let resultChart = null;
        
        // 初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            // 检查配置
            const savedConfig = localStorage.getItem('dbAssistantConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                updateConfigUI();
            }
            
            // 初始化数据库连接状态
            checkDatabaseConnection();
            
            // 初始化图表
            initChart();
        });
        
        // 更新配置UI
        function updateConfigUI() {
            document.getElementById('apiUrl').value = config.apiUrl;
            document.getElementById('dbConnection').value = config.dbConnection;
            document.getElementById('modelSelect').value = config.model;
            document.getElementById('autoVisualize').checked = config.autoVisualize;
            document.getElementById('modelStatus').textContent = `Text2SQL 模型: ${config.model.toUpperCase()}`;
        }
        
        // 检查数据库连接状态
        async function checkDatabaseConnection() {
            const dbStatusDot = document.getElementById('dbStatusDot');
            const dbStatusText = document.getElementById('dbStatusText');
            
            try {
                // 模拟数据库连接检查
                dbStatusDot.className = 'status-dot';
                dbStatusText.textContent = '正在连接数据库...';
                
                // 实际应用中这里应该调用API检查数据库连接
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                dbStatusDot.className = 'status-dot connected';
                dbStatusText.textContent = '已连接: MySQL 销售数据库';
            } catch (error) {
                dbStatusDot.className = 'status-dot disconnected';
                dbStatusText.textContent = '数据库连接失败';
            }
        }
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('resultChart').getContext('2d');
            resultChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: '查询结果',
                            color: '#fff',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }
        
        // 发送消息到后端
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (message === '') return;
            
            // 添加用户消息
            addMessage(message, 'user');
            
            // 清空输入框
            userInput.value = '';
            
            // 显示系统正在输入指示器
            showTypingIndicator();
            
            try {
                // 发送请求到后端
                const response = await axios.post(config.apiUrl, {
                    question: message,
                    conversation_id: conversationId,
                    db_connection: config.dbConnection,
                    model: config.model
                });
                
                // 移除输入指示器
                removeTypingIndicator();
                
                // 处理响应
                handleResponse(response.data);
                
                // 更新会话ID（用于多轮对话）
                if (response.data.conversation_id) {
                    conversationId = response.data.conversation_id;
                }
            } catch (error) {
                removeTypingIndicator();
                handleError(error);
            }
        }
        
        // 处理后端响应
        function handleResponse(data) {
            if (data.error) {
                addMessage(`处理请求时出错: ${data.error}`, 'system');
                return;
            }
            
            // 显示SQL查询
            addSqlMessage(data.sql);
            
            // 显示系统消息
            addMessage(data.message || '已成功查询到以下结果:', 'system');
            
            // 可视化结果
            if (data.result && data.result.length > 0 && config.autoVisualize) {
                visualizeResult(data.result, data.visualization);
            }
        }
        
        // 处理错误
        function handleError(error) {
            let errorMsg = '请求处理失败';
            
            if (error.response) {
                // 服务器响应了错误状态码
                errorMsg = `服务器错误: ${error.response.status} - ${error.response.data.error || '未知错误'}`;
            } else if (error.request) {
                // 请求已发出但没有收到响应
                errorMsg = '无法连接到服务器，请检查API地址';
            } else {
                // 请求配置出错
                errorMsg = `请求配置错误: ${error.message}`;
            }
            
            addMessage(errorMsg, 'system');
        }
        
        // 添加消息到聊天框
        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-user me-2 text-primary"></i>
                        <strong>用户</strong>
                    </div>
                    <p>${content}</p>
                `;
            } else {
                messageDiv.className = 'message system-message';
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot me-2 text-success"></i>
                        <strong>数据库助手</strong>
                    </div>
                    <p>${content}</p>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加SQL消息
        function addSqlMessage(sql) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message sql-message';
            messageDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-code me-2 text-success"></i>
                    <strong>SQL查询</strong>
                    <span class="badge badge-sql ms-2">${config.dbConnection.split(':')[0]}</span>
                </div>
                <pre>${sql}</pre>
            `;
            
            // 添加复制按钮
            const copyBtn = document.createElement('button');
            copyBtn.className = 'sql-copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy me-1"></i>复制';
            copyBtn.onclick = () => copyToClipboard(sql);
            messageDiv.appendChild(copyBtn);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = event.target.closest('.sql-copy-btn');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>已复制';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }
            });
        }
        
        // 显示系统正在输入
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message system-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2 text-success"></i>
                    <strong>数据库助手</strong>
                </div>
                <div class="typing-indicator mt-2">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 移除系统正在输入指示器
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // 可视化结果
        function visualizeResult(data, chartType) {
            if (!data || data.length === 0) {
                addMessage('查询结果为空', 'system');
                return;
            }
            
            // 显示可视化容器
            const container = document.getElementById('visualizationContainer');
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth' });
            
            // 更新表格
            updateTable(data);
            
            // 更新图表
            updateChart(data, chartType);
        }
        
        // 更新表格
        function updateTable(data) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // 清空表格
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // 添加表头
            const keys = Object.keys(data[0]);
            keys.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                tableHeader.appendChild(th);
            });
            
            // 添加数据行
            data.forEach(row => {
                const tr = document.createElement('tr');
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = row[key];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        // 更新图表
        function updateChart(data, chartType = 'bar') {
            // 如果没有数据，保持图表为空
            if (data.length === 0) return;
            
            const keys = Object.keys(data[0]);
            const labels = [];
            const values = [];
            
            // 尝试确定标签和数据列
            let labelKey = keys[0];
            let valueKey = keys[1];
            
            // 寻找数值列
            for (let i = 1; i < keys.length; i++) {
                if (typeof data[0][keys[i]] === 'number') {
                    valueKey = keys[i];
                    break;
                }
            }
            
            // 提取标签和数据
            data.forEach(item => {
                labels.push(item[labelKey]);
                values.push(item[valueKey]);
            });
            
            // 确定图表类型
            const chartTypes = ['bar', 'line', 'pie'];
            if (!chartTypes.includes(chartType)) {
                chartType = values.length > 10 ? 'line' : 'bar';
            }
            
            // 更新图表数据
            resultChart.data.labels = labels;
            resultChart.data.datasets = [{
                label: valueKey,
                data: values,
                backgroundColor: getColors(values.length, chartType),
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1
            }];
            
            // 更新图表类型
            resultChart.config.type = chartType;
            resultChart.update();
        }
        
        // 生成颜色数组
        function getColors(count, type) {
            const colors = [];
            const baseColors = [
                'rgba(67, 97, 238, 0.7)',
                'rgba(76, 201, 240, 0.7)',
                'rgba(247, 37, 133, 0.7)',
                'rgba(106, 76, 219, 0.7)',
                'rgba(72, 199, 142, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(253, 126, 20, 0.7)',
                'rgba(32, 201, 151, 0.7)'
            ];
            
            if (type === 'pie') {
                for (let i = 0; i < count; i++) {
                    colors.push(baseColors[i % baseColors.length]);
                }
            } else {
                return baseColors[0];
            }
            
            return colors;
        }
        
        // 保存配置
        function saveConfig() {
            config.apiUrl = document.getElementById('apiUrl').value;
            config.dbConnection = document.getElementById('dbConnection').value;
            config.model = document.getElementById('modelSelect').value;
            config.autoVisualize = document.getElementById('autoVisualize').checked;
            
            localStorage.setItem('dbAssistantConfig', JSON.stringify(config));
            updateConfigUI();
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
            modal.hide();
        }
        
        // 事件监听
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 示例问题点击事件
        document.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                const question = card.getAttribute('data-question');
                document.getElementById('userInput').value = question;
                sendMessage();
            });
        });
        
        // 图表/表格切换
        document.querySelectorAll('[data-type]').forEach(btn => {
            btn.addEventListener('click', () => {
                // 切换激活状态
                document.querySelectorAll('[data-type]').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                
                // 显示对应内容
                const type = btn.getAttribute('data-type');
                if (type === 'chart') {
                    document.querySelector('.chart-container').classList.remove('d-none');
                    document.querySelector('.table-container').classList.add('d-none');
                } else {
                    document.querySelector('.chart-container').classList.add('d-none');
                    document.querySelector('.table-container').classList.remove('d-none');
                }
            });
        });
        
        // 保存配置按钮
        document.getElementById('saveConfig').addEventListener('click', saveConfig);
        
        // 连接数据库按钮
        document.getElementById('connectBtn').addEventListener('click', checkDatabaseConnection);
    </script>
</body>
</html>